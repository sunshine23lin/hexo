---
title: JVM篇之垃圾回收器G1
date: 2020-12-31 10:10:36
categories: JVM
tags: 垃圾回收器
---

##  背景

G1（Garbage-First）是一款面向服务端应用的垃圾收集器，主要针对配备多核CPU及大容量内存的机器，以极高概率满足GC停顿时间的同时，还兼具高吞吐量的性质。

在JDK1.7版本正式启动，移除了Experimental的标识，是JDK9以后的默认垃圾回收器，取代了CMS回收器以及Parallel组合，被Oracle官方称为“全功能垃圾收集器”。

##  特点

分代收集

- 从分代上看，G1依然属于分代型垃圾回收器，它会区分年轻代和老年代，年轻代依然有Eden区和Survivor区。从堆的结构上看，他不要求整个Eden区，Old区都是固定的，也不再坚持固定大小和固定数量。
- 将堆空间划分若干个区域，这些区域中包括了逻辑上年轻代和老年代。

空间整合

- G1将内存划分为一个个的region，内存回收以region作为基本单位。Region之间是复制算法，但整体上实际可以看做标记-压缩算法。两种算法都可以避免内存碎片化。这种特性有利于程序长时间运行，分配大对象时不会因为无法找到连续内存空间而提前触发下一次GC。尤其当Java堆非常大时候，G1优势更加明显。

可预测模型

G1除了追求低停顿外，还能建立可预测模型的停顿时间，能让使用者明确规定在一个长度为M毫秒的时间片段内，消耗在垃圾收集上的时间不得超过N毫秒。

- 由于分区原因，G1可以只选取部分区域进行内存回收，这样缩小了回收的范畴，因此在全局停顿的情况下也能较好的控制
- G1跟踪各个region里面的垃圾堆积的价值大小（回收所获得的空间大小和回收所需时间经验值），在后台维护一个优先列表，每次根据允许的收集时间，优先回收价值最大的region。保证了G1收集器在有限时间内可以获得尽可能高的收集效率。

##  分区Region

使用G1收集器，它将整个java堆划分约2048个大小相同独立Region块，每个Region块大小根据堆空间的实际大小而定，整体被控制在1MB到32MB之间，且为2的N次幂，即1MB、2MB、4MB、8MB、16MB、32MB。可以通过-XX:C1HeapRegionSize设定，所有的Region大小相同，且在JVM生命周期内不会被改变。

<img src="https://jameslin23.gitee.io/2020/12/30/JVM篇之垃圾回收器G1/image-20201231110613736.png" alt="image-20201231110613736" style="zoom: 67%;" />

- 一个region有可能属于Eden,Survivor或者Old内存区域。但一个region只能属于一个角色。
- G1还增加一个新的内存区域，叫做Humongous内存区域，主要存储大对象。

设置H的原因

> 对于堆中的大对象，默认直接分配到老年代，但是如果它是一个短期存在的大对象，就会占用老年代内存。为了解决这个问题，G1划分了一个Humongous区，它用来专门存放大对象。如果一个H区装不下一个大对象，那么G1会寻找连续H区来存储。

##  垃圾回收过程

G1垃圾回收主要包括以下3个环节

- 年轻代GC
- 老年代并发标记过程
- 混合回收
- 失败保护机制（Full GC）

**总体概况**

当年轻代的Eden区用尽时开始年轻代回收；G1暂停所有应用程序线程，启动多线程执行年轻代回收。年轻代区间存活对象移动到survivor区或者old；当堆内存使用达到一定值（默认45）时，开始老年代并发标记过程。标记完成马上开始混合回收过程。对于一个混合回收期，G1从老年代移动存活对象到空闲区，G1老年代回收不需要整个老年代被回收，一次只需要扫描/回收一小部分老年代的region即可。

**Remembered Set**

存在一个Region中的对象被其它任意Region对象引用，避免扫描整个java堆。

每个Region都有一个对应Remembered Set;记录其它对象对自己的引用。

<img src="https://jameslin23.gitee.io/2020/12/30/JVM篇之垃圾回收器G1/image-20201231114119798.png" alt="image-20201231114119798" style="zoom: 50%;" />

##  常用的设置

- **-XX:+UseG1GC** 手动指定使用G1收集器执行内存回收任务
- **-XX:G1HeapRegionSize** 设置Region的大小，值是2的幂，范围是1MB到32MB之间，目标是根据最小堆可以划分约2048个区域，默认是堆内存的1/2000。
- **-XX:MaxGCPauseMillis** 设置期望达到的最大GC停顿时间指标（JVM会尽力实现，但不能保证成功），默认值200ms
- **-XX:ParallelGCThead** 设置STW工作线程数的值，最多设置为8
- **-XX:ConcGCThreads** 设置并发标记的线程数
- **-XX:InitiatingHeapOccupancyPercent** 设置触发并发GC周期的Java堆占用率阈值，超过此值，就触发GC。默认值是45。

##  操作方法

- 开启G1垃圾收集器
- 设置堆最大内存
- 设置停顿时间

## 应用场景

- 面向服务端应用，针对具有大内存、多处理器的机器



