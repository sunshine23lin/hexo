---
title: JVM篇之垃圾回收器CMS
date: 2020-12-31 08:31:20
categories: JVM
tags: 垃圾回收器
---

##  背景

- 在JDK 1.5时期，HotSpot推出一款在强交互应用中几乎认为有划时代意义的垃圾收集器：CMS(Concurrent-Mark-Sweep)收集器，这款收集器是HotSpot虚拟机中第一款真正意义上的并发收集器，他第一次实现了让垃圾收集线程与用户线程同时工作，
- CMS的关注点是尽可能缩短垃圾收集时用户线程的停顿时间。停顿时间越短（低延迟）就越适合与用户交互程序，良好的响应速度能提高用户体验。

##  工作原理

CMS整个过程比之前收集器要复杂，整个过程分4个主要阶段，即初始标记阶段、并发标记阶段、重新标记阶段和并发清除阶段。

- 初始标记阶段：在这个阶段中，程序所有的工作线程都将会因为STW机制而出现短暂的暂停。这个阶段的主要任务仅仅只是标记处GC ROOTS能直接关联对象。一旦标记完成之后就会恢复之前被暂停的所有应用线程。由于直接关联对象比较少，速度很快。
- 并发标记阶段：从GC Roots的直接关联对象开始遍历整个对象图过程，这个过程耗时比较长，与用户线程一起并行执行。
- 重新标记：修正并发标记期间，因用户程序继续运行而导致标记产生变动的那一部分对象的标记记录。（STW）
- 并发清除：清除删除掉标记阶段判断已经死亡的对象，释放空间

**示意图**

<img src="https://jameslin23.gitee.io/2020/12/30/JVM篇之垃圾回收器CMS/image-20201231091620401.png" alt="image-20201231091620401" style="zoom:80%;" />

尽管CMS收集器采用的是并发回收，但在其初始化标记和再次标记这两个阶段中仍然会出现STW，不过暂停时间不会太长，因此说明所有垃圾收集器都做不到完全不需要STW,只是尽可能地缩短暂停时间。

由于垃圾收集阶段用户没有线程中断，所以在CMS回收过程中，还应该确保应用程序用户线程有足够的内存可见。CMS收集器不能像其他收集器那样等到老年代几乎完全填满了再去收集，而是当堆内存使用率达到某一个阈值时，便开始回收。以确保应用程序在CMS工作过程中依然有足够的空间支持应用程序运行。要是CMS运行期间预留的内存无法满足程序需要，就出现一次"Concurrent Mode Failure"失败，这时虚拟机将启动后备预案：临时启用Serial Old收集器进行老年代的垃圾收集，这样停顿就会很长。

**CMS的优点：**

- 并发收集
- 低延迟

**CMS的弊端**

- 产生碎片化
- 对CPU资源非常敏感
- 无法处理浮动垃圾

##  参数设置

**-XX:+UseConcMarkSweepGC**

手动指定使用CMS，收集器执行内存回收任务。开启该参数后会自动将-XX:+UseParNewGC打开，即ParNew+CMS+Serial Old组成

**-XX:CMSlnitiatingOccupanyFraction**

设置堆内存使用率的阈值，一旦到达阈值，即开始进行回收

- JDK5以及以前版本默认为68，即当老年代的空间使用率达到68%时，会执行一次CMS回收，JDK6以上默认值92%
- 如果内存增长缓慢，则可以设置一个稍大的值，大的阈值可以有效降低CMS的触发频率，减少老年代回收的次数可以较为明显地改善应用程序性能。反之，如果应用程序内存使用增长率很快，则可以降低这个阈值，以避免触发Serial Old进行收集。

**-XX:+UseCMSCompactAtFullCollection**

用于指定在执行完Full GC后对内存空间进行压缩整理，以此避免内存碎片产生。不过由于内存压缩整理过程无法并行执行，带来问题停顿时间更长了。

**-XX:CMSFullGSsBeforeCompaction**

设置在执行多少次Full GC后对内存进行压缩整理。

**-XX:ParallelCMSThreads**

设置线程数量。

CMS默认启动线程数是（ParallelGCTheads+3）/4，ParallelGCTheads 是年轻代收集器线程数，当CPU资源比较紧张，受CMS收集器线程的影响，应用程序的性能在垃圾回收阶段可能会非常糟糕。

##  JDK后续版本中CMS的变化。

- JDK9新特性：CMS被标记为Deprecate了（JEP291）,如果对JDK9及以上版本HotSpot虚拟机使用参数-XX:+UseConcMarkSweepGC来开启CMS收集器的话，用户会收到一个告警信息，提示CMS未来将会被废弃。
- JDK14新特性：删除CMS垃圾回收器（JEP363）移除CMS垃圾回收器。如果在JDK14设置XX:+UseConcMarkSweepGC的话，JVM不会报错，只有给出一个warning信息，但是不会exit。JVM会自动回退默认GC方式启动JVM